<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Character Animation with Subtitles</title>
    <style>
        /* Reset default margins and paddings */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body styles */
        body {
            overflow: hidden;
            background-color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        /* Top bar styles */
        .top-bar {
            width: 100%;
            padding: 10px;
            background-color: #111;
            display: flex;
            justify-content: center;
            gap: 10px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .top-bar input[type="file"] {
            display: none;
        }

        .top-bar label {
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .top-bar label:hover {
            background-color: #555;
        }

        /* Canvas styles */
        canvas {
            display: block; /* Removes any unwanted gaps */
            width: 100%;
            height: 80vh;
            margin-top: 60px; /* To prevent overlap with top bar */
        }

        /* Audio player styles */
        .audio-player {
            margin-top: 20px;
            z-index: 10;
        }

        .audio-player audio {
            width: 300px;
        }
    </style>
</head>
<body>
    <!-- Top bar with upload buttons -->
    <div class="top-bar">
        <div>
            <input type="file" id="uploadWav" accept=".wav">
            <label for="uploadWav">上傳 WAV</label>
        </div>
        <div>
            <input type="file" id="uploadSrt" accept=".srt">
            <label for="uploadSrt">上傳 SRT</label>
        </div>
    </div>

    <!-- Canvas -->
    <canvas></canvas>

    <!-- Audio player -->
    <div class="audio-player">
        <audio controls id="audioPlayer">
            <source src="" type="audio/wav">
            Your browser does not support the audio element.
        </audio>
    </div>

    <script>
        window.onload = () => {
            const CANVAS = document.getElementsByTagName("canvas")[0];
            const CTX = CANVAS.getContext("2d");
            let CHARS = [];
            const MAX_CHARS = 200;
            const SEPARATION = 1;

            let ww, wh, camera;

            class Vector {
                constructor(x, y, z) {
                    this.x = x;
                    this.y = y;
                    this.z = z;
                }

                rotate(dir, ang) {
                    const X = this.x;
                    const Y = this.y;
                    const Z = this.z;

                    const SIN = Math.sin(ang);
                    const COS = Math.cos(ang);

                    if (dir === "x") {
                        this.y = Y * COS - Z * SIN;
                        this.z = Y * SIN + Z * COS;
                    } else if (dir === "y") {
                        this.x = X * COS - Z * SIN;
                        this.z = X * SIN + Z * COS;
                    }
                }

                project() {
                    const ZP = this.z + camera.z;
                    const DIV = ZP / wh;
                    const XP = (this.x + camera.x) / DIV;
                    const YP = (this.y + camera.y) / DIV;
                    const CENTER = getCenter();
                    return [XP + CENTER[0], YP + CENTER[1], ZP];
                }
            }

            class Char {
                constructor(letter, pos) {
                    this.letter = letter;
                    this.pos = pos;
                }

                rotate(dir, ang) {
                    this.pos.rotate(dir, ang);
                }

                render() {
                    const PIXEL = this.pos.project();
                    const XP = PIXEL[0];
                    const YP = PIXEL[1];
                    const MAX_SIZE = 50;
                    const SIZE = Math.floor((1 / PIXEL[2] * MAX_SIZE));
                    const BRIGHTNESS = SIZE / MAX_SIZE;
                    const blueComponent = Math.floor(100 * BRIGHTNESS) + 150;
                    const COL = `rgba(255, 255, ${blueComponent}, ${BRIGHTNESS})`;

                    CTX.fillStyle = COL;
                    CTX.font = `${SIZE}px monospace`;
                    CTX.fillText(this.letter, XP, YP);
                }
            }

            function getCenter() {
                return [ww / 2, wh / 2];
            }

            function signedRandom() {
                return Math.random() - Math.random();
            }

            function render() {
                for (let i = 0; i < CHARS.length; i++) {
                    CHARS[i].render();
                }
            }

            let time = 0;
            function update() {
                CTX.clearRect(0, 0, ww, wh);
                for (let i = 0; i < CHARS.length; i++) {
                    const DX = 0.005 * Math.sin(time * 0.001);
                    const DY = 0.005 * Math.cos(time * 0.001);
                    CHARS[i].rotate("x", DX);
                    CHARS[i].rotate("y", DY);
                }
                ++time;
            }

            function loop() {
                window.requestAnimationFrame(loop);
                update();
                render();
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function createChars() {
                CHARS = []; // Clear existing chars
                for (let i = 0; i < MAX_CHARS; i++) {
                    const CHARACTER = String.fromCharCode(Math.floor(Math.random() * 93) + 34);
                    const X = signedRandom() * SEPARATION;
                    const Y = signedRandom() * SEPARATION;
                    const Z = signedRandom() * SEPARATION;
                    const POS = new Vector(X, Y, Z);
                    const CHAR = new Char(CHARACTER, POS);
                    CHARS.push(CHAR);
                }
            }

            function createCharsByQueryString(str) {
                CHARS = []; // Clear existing chars
                const strLength = str.length;

                for (let i = 0; i < MAX_CHARS; i++) {
                    // 從指定的字串中循環選取字元
                    const CHARACTER = str[i % strLength];
                    const X = signedRandom() * SEPARATION;
                    const Y = signedRandom() * SEPARATION;
                    const Z = signedRandom() * SEPARATION;
                    const POS = new Vector(X, Y, Z);
                    const CHAR = new Char(CHARACTER, POS);
                    CHARS.push(CHAR);
                }
            }

            function setDim() {
                ww = window.innerWidth;
                wh = window.innerHeight;
                CANVAS.width = ww * window.devicePixelRatio;
                CANVAS.height = wh * window.devicePixelRatio;
                CTX.scale(window.devicePixelRatio, window.devicePixelRatio);
            }

            function initCamera() {
                camera = new Vector(0, 0, SEPARATION + 1);
            }

            window.onresize = () => {
                setDim();
            };

            // Handle file uploads
            document.getElementById('uploadWav').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = URL.createObjectURL(file);
                    audioPlayer.load();
                }
            });

            // Subtitle handling
            let subtitles = [];
            let currentSubtitleIndex = -1;

            document.getElementById('uploadSrt').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file && file.name.endsWith('.srt')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const srtText = event.target.result;
                        subtitles = parseSRT(srtText);
                        console.log(subtitles);
                    };
                    reader.readAsText(file);
                } else {
                    alert('請上傳有效的 .srt 文件。');
                }
            });

            function parseSRT(data) {
                const pattern = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3})\s-->\s(\d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n{2,}|$)/g;
                let result;
                const subtitles = [];

                while ((result = pattern.exec(data)) !== null) {
                    const index = parseInt(result[1]);
                    const start = timeStringToSeconds(result[2]);
                    const end = timeStringToSeconds(result[3]);
                    const text = result[4].replace(/\n/g, ' ').trim();
                    subtitles.push({ index, start, end, text });
                }

                return subtitles;
            }

            function timeStringToSeconds(timeString) {
                const parts = timeString.split(':');
                const secondsParts = parts[2].split(',');
                const hours = parseInt(parts[0]);
                const minutes = parseInt(parts[1]);
                const seconds = parseInt(secondsParts[0]);
                const milliseconds = parseInt(secondsParts[1]);
                return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
            }

            // Update 3D chars based on current subtitle
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.addEventListener('timeupdate', function() {
                const currentTime = audioPlayer.currentTime;
                let subtitle = null;

                for (let i = 0; i < subtitles.length; i++) {
                    if (currentTime >= subtitles[i].start && currentTime <= subtitles[i].end) {
                        subtitle = subtitles[i].text;
                        if (currentSubtitleIndex !== i) {
                            currentSubtitleIndex = i;
                            createCharsByQueryString(subtitle);
                        }
                        break;
                    }
                }

                // If no subtitle is active
                if (!subtitle && currentSubtitleIndex !== -1) {
                    currentSubtitleIndex = -1;
                    createChars(); // Optionally reset to random chars
                }
            });

            (function init() {
                setDim();
                initCamera();
                createChars();
                loop();
            })();
        };
    </script>
</body>
</html>
