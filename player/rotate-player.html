<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Character Animation</title>
    <style>
        /* Reset default margins and paddings */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body styles */
        body {
            overflow: hidden;
            background-color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Canvas styles */
        canvas {
            display: block; /* Removes any unwanted gaps */
            width: 100%;
            height: 80vh;
        }

        /* Upload buttons styles */
        .upload-container {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .upload-container input {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 10px;
            cursor: pointer;
        }

        /* Audio player styles */
        .audio-player {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Upload buttons -->
    <div class="upload-container">
        <input type="file" id="uploadWav" accept=".wav">
        <input type="file" id="uploadSrt" accept=".srt">
    </div>

    <!-- Canvas -->
    <canvas></canvas>

    <!-- Audio player -->
    <div class="audio-player">
        <audio controls id="audioPlayer" style="width: 300px;">
            <source src="" type="audio/wav">
            Your browser does not support the audio element.
        </audio>
    </div>

    <script>
        window.onload = () => {
            const CANVAS = document.getElementsByTagName("canvas")[0];
            const CTX = CANVAS.getContext("2d");
            const CHARS = [];
            const MAX_CHARS = 200;
            const SEPARATION = 1;

            let ww, wh, camera;

            class Vector {
                constructor(x, y, z) {
                    this.x = x;
                    this.y = y;
                    this.z = z;
                }

                rotate(dir, ang) {
                    const X = this.x;
                    const Y = this.y;
                    const Z = this.z;

                    const SIN = Math.sin(ang);
                    const COS = Math.cos(ang);

                    if (dir === "x") {
                        this.y = Y * COS - Z * SIN;
                        this.z = Y * SIN + Z * COS;
                    } else if (dir === "y") {
                        this.x = X * COS - Z * SIN;
                        this.z = X * SIN + Z * COS;
                    }
                }

                project() {
                    const ZP = this.z + camera.z;
                    const DIV = ZP / wh;
                    const XP = (this.x + camera.x) / DIV;
                    const YP = (this.y + camera.y) / DIV;
                    const CENTER = getCenter();
                    return [XP + CENTER[0], YP + CENTER[1], ZP];
                }
            }

            class Char {
                constructor(letter, pos) {
                    this.letter = letter;
                    this.pos = pos;
                }

                rotate(dir, ang) {
                    this.pos.rotate(dir, ang);
                }

                render() {
                    const PIXEL = this.pos.project();
                    const XP = PIXEL[0];
                    const YP = PIXEL[1];
                    const MAX_SIZE = 50;
                    const SIZE = Math.floor((1 / PIXEL[2] * MAX_SIZE));
                    const BRIGHTNESS = SIZE / MAX_SIZE;
                    const blueComponent = Math.floor(100 * BRIGHTNESS) + 150;
                    const COL = `rgba(255, 255, ${blueComponent}, ${BRIGHTNESS})`;

                    CTX.fillStyle = COL;
                    CTX.font = `${SIZE}px monospace`;
                    CTX.fillText(this.letter, XP, YP);
                }
            }

            function getCenter() {
                return [ww / 2, wh / 2];
            }

            function signedRandom() {
                return Math.random() - Math.random();
            }

            function render() {
                for (let i = 0; i < CHARS.length; i++) {
                    CHARS[i].render();
                }
            }

            let time = 0;
            function update() {
                CTX.clearRect(0, 0, ww, wh);
                for (let i = 0; i < CHARS.length; i++) {
                    const DX = 0.005 * Math.sin(time * 0.001);
                    const DY = 0.005 * Math.cos(time * 0.001);
                    CHARS[i].rotate("x", DX);
                    CHARS[i].rotate("y", DY);
                }
                ++time;
            }

            function loop() {
                window.requestAnimationFrame(loop);
                update();
                render();
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function createChars() {
                for (let i = 0; i < MAX_CHARS; i++) {
                    const CHARACTER = String.fromCharCode(Math.floor(Math.random() * 93) + 34);
                    const X = signedRandom() * SEPARATION;
                    const Y = signedRandom() * SEPARATION;
                    const Z = signedRandom() * SEPARATION;
                    const POS = new Vector(X, Y, Z);
                    const CHAR = new Char(CHARACTER, POS);
                    CHARS.push(CHAR);
                }
            }

            function createCharsByQueryString(str) {
              const strLength = str.length;

              for (let i = 0; i < MAX_CHARS; i++) {
                  // 從指定的字串中隨機選取一個字元
                  const CHARACTER = str[i % strLength];  // 循環顯示 "GPT"
                  const X = signedRandom() * SEPARATION;
                  const Y = signedRandom() * SEPARATION;
                  const Z = signedRandom() * SEPARATION;
                  const POS = new Vector(X, Y, Z);
                  const CHAR = new Char(CHARACTER, POS);
                  CHARS.push(CHAR);
              }
          }

            function setDim() {
                ww = window.innerWidth;
                wh = window.innerHeight;
                CANVAS.width = ww * window.devicePixelRatio;
                CANVAS.height = wh * window.devicePixelRatio;
                CTX.scale(window.devicePixelRatio, window.devicePixelRatio);
            }

            function initCamera() {
                camera = new Vector(0, 0, SEPARATION + 1);
            }

            window.onresize = () => {
                setDim();
            };

            // Handle file uploads
            document.getElementById('uploadWav').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = URL.createObjectURL(file);
                    audioPlayer.load();
                }
            });

            (function init() {
                setDim();
                initCamera();
                const params = new URLSearchParams(window.location.search);
                const text = params.get('text');
                if (text) {
                  createCharsByQueryString(text);
                } else {
                  createChars();
                }
                loop();
            })();
        };
    </script>
</body>
</html>
