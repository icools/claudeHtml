<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Map Generator</title>
    <!-- 升級到最新的 Mermaid.js 版本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.4/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 600px;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #result {
            margin-top: 20px;
            width: 100%;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <input type="password" id="apiKey" placeholder="輸入你的Groq API Key">
        <input type="text" id="input" placeholder="輸入你的需求">
        <button onclick="generateMindMap()">送出</button>
        <div id="result"></div>
    </div>

    <script>
        async function generateMindMap() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const input = document.getElementById('input').value.trim();
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Loading...';

            if (!apiKey) {
                resultDiv.innerHTML = '請輸入 API Key。';
                return;
            }

            if (!input) {
                resultDiv.innerHTML = '請輸入需求。';
                return;
            }

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: "system",
                                content: "1. 用 Mermaid 產生這個 mind map 的語法，不需額外解說，2. 預期應該是 flowchart LR 或 sequenceDiagram 之類的開頭，不要給 ```mermaid 的寫法，3. 用繁體中文回答，4. 用 <mermaid></mermaid> 回答，5. 請確保使用標準的箭頭符號（如 -->、--->）"
                            },
                            {
                                role: "user",
                                content: `用 Mermaid 產生 mind map，${input}`
                            }
                        ],
                        model: "llama-3.2-11b-text-preview",
                        temperature: 1,
                        max_tokens: 1024,
                        top_p: 1,
                        stream: false,
                        stop: null
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed with status ' + response.status);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                console.log('Response:', content);

                // 提取 <mermaid> 區塊中的內容
                const mermaidMatch = content.match(/<mermaid>([\s\S]*?)<\/mermaid>/i);
                if (mermaidMatch && mermaidMatch[1]) {
                    let mermaidCode = mermaidMatch[1].trim();
                    console.log('Original Mermaid Code:', mermaidCode);

                    // 預處理：替換可能的非標準箭頭符號
                    mermaidCode = mermaidCode
                        .replace(/〈-/g, '-->')      // 替換可能的全形箭頭
                        .replace(/〈-/g, '-->')      // 重複替換確保所有情況
                        .replace(/〈/g, '<')          // 替換其他全形符號
                        .replace(/〉/g, '>')          // 替換其他全形符號
                        .replace(/–-/g, '--')        // 替換其他類似符號
                        .replace(/--〉/g, '-->')      // 替換特定的箭頭
                        .replace(/—>/g, '-->')        // 替換長破折號
                        .replace(/--->/g, '-->')      // 替換更長的箭頭
                        .replace(/→/g, '-->')          // 替換右箭頭符號
                        .replace(/←/g, '<--')          // 替換左箭頭符號
                        .replace(/↔/g, '<-->');        // 替換雙向箭頭符號

                    console.log('Sanitized Mermaid Code:', mermaidCode);

                    // 使用 Mermaid.js 生成圖表
                    resultDiv.innerHTML = '<div class="mermaid">' + mermaidCode + '</div>';
                    mermaid.contentLoaded(); // 更新為最新的初始化方法
                } else {
                    console.log('Response does not contain valid Mermaid syntax.');
                    resultDiv.innerHTML = '回應中未找到有效的 Mermaid 語法。';
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = '生成心智圖時出現錯誤，請稍後再試。';
            }
        }

        // 初始化 Mermaid
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html>
